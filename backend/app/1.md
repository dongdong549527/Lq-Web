ç²®åº“ç²®ä»“ç®¡ç†ç³»ç»Ÿ - Next.js å…¨æ ˆå¼€å‘æ–‡æ¡£
é¡¹ç›®æ¦‚è¿°
åŸºäº Next.js 14 çš„ç²®åº“ç²®ä»“ç®¡ç†ç³»ç»Ÿï¼ŒåŒ…å«å®Œæ•´çš„æ•°æ®åº“è®¾è®¡ã€APIæ¥å£ã€å‰ç«¯ç»„ä»¶å’Œéƒ¨ç½²é…ç½®ã€‚

æŠ€æœ¯æ ˆ
å‰ç«¯æ¡†æ¶: Next.js 14 (App Router)

UI ç»„ä»¶åº“: Ant Design / shadcn/ui

æ ·å¼æ–¹æ¡ˆ: Tailwind CSS

åç«¯æ¡†æ¶: Next.js API Routes (Server Actions)

ORM: Prisma

æ•°æ®åº“: MySQL 8.0

è®¤è¯æˆæƒ: NextAuth.js

è¡¨å•å¤„ç†: React Hook Form + Zod

çŠ¶æ€ç®¡ç†: Zustand / React Context

å›¾è¡¨åº“: Recharts

åœ°å›¾ç»„ä»¶: Leaflet (å¯é€‰)

æ•°æ®åº“è®¾è®¡
æ ¸å¿ƒè¡¨ç»“æ„
1. ç²®åº“ä¿¡æ¯è¡¨ (granary_base)
sql
CREATE TABLE granary_base (
    base_id INT PRIMARY KEY AUTO_INCREMENT,
    base_code VARCHAR(20) UNIQUE NOT NULL,
    base_name VARCHAR(100) NOT NULL,
    province VARCHAR(50),
    city VARCHAR(50),
    district VARCHAR(50),
    address VARCHAR(200),
    base_type ENUM('å›½å®¶å‚¨å¤‡åº“', 'åœ°æ–¹å‚¨å¤‡åº“', 'ä¼ä¸šä»“åº“') DEFAULT 'åœ°æ–¹å‚¨å¤‡åº“',
    status ENUM('å¯ç”¨', 'åœç”¨', 'åœ¨å»º') DEFAULT 'å¯ç”¨',
    total_capacity DECIMAL(12, 2),
    contact_person VARCHAR(50),
    contact_phone VARCHAR(20),
    established_date DATE,
    manager_user_id INT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
2. ç²®ä»“ä¿¡æ¯è¡¨ (granary_storehouse)
sql
CREATE TABLE granary_storehouse (
    storehouse_id INT PRIMARY KEY AUTO_INCREMENT,
    storehouse_code VARCHAR(20) NOT NULL,
    base_id INT NOT NULL,
    storehouse_name VARCHAR(100) NOT NULL,
    storehouse_type ENUM('å¹³æˆ¿ä»“', 'ç­’ä»“', 'æµ…åœ†ä»“', 'æ¥¼æˆ¿ä»“') DEFAULT 'å¹³æˆ¿ä»“',
    design_capacity DECIMAL(10, 2) NOT NULL,
    length DECIMAL(8, 2),
    width DECIMAL(8, 2),
    height DECIMAL(8, 2),
    diameter DECIMAL(8, 2),
    construction_date DATE,
    status ENUM('ç©ºä»“', 'å­˜å‚¨ä¸­', 'ç»´ä¿®ä¸­', 'å·²åºŸå¼ƒ') DEFAULT 'ç©ºä»“',
    temperature_control BOOLEAN DEFAULT FALSE,
    humidity_control BOOLEAN DEFAULT FALSE,
    fire_protection_level VARCHAR(20),
    current_grain_id INT,
    current_quantity DECIMAL(10, 2) DEFAULT 0,
    safety_level ENUM('æ­£å¸¸', 'é¢„è­¦', 'å±é™©') DEFAULT 'æ­£å¸¸',
    last_inspection_date DATE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    UNIQUE KEY uk_base_code (base_id, storehouse_code),
    FOREIGN KEY (base_id) REFERENCES granary_base(base_id) ON DELETE CASCADE
);
3. ç²®é£Ÿå­˜å‚¨è®°å½•è¡¨ (grain_storage)
sql
CREATE TABLE grain_storage (
    storage_id INT PRIMARY KEY AUTO_INCREMENT,
    storehouse_id INT NOT NULL,
    grain_type VARCHAR(50) NOT NULL,
    grade VARCHAR(20),
    production_year YEAR,
    origin_province VARCHAR(50),
    origin_city VARCHAR(50),
    quantity DECIMAL(10, 2) NOT NULL,
    unit_price DECIMAL(8, 2),
    storage_date DATE NOT NULL,
    expiration_date DATE,
    supplier VARCHAR(100),
    purchase_order_no VARCHAR(50),
    inspector VARCHAR(50),
    moisture_content DECIMAL(5, 2),
    impurity_content DECIMAL(5, 2),
    storage_type ENUM('å›½å®¶å‚¨å¤‡', 'åœ°æ–¹å‚¨å¤‡', 'å•†å“ç²®') DEFAULT 'åœ°æ–¹å‚¨å¤‡',
    status ENUM('åœ¨å‚¨', 'å·²å‡ºåº“', 'è½®æ¢ä¸­') DEFAULT 'åœ¨å‚¨',
    outbound_date DATE,
    outbound_quantity DECIMAL(10, 2),
    outbound_reason VARCHAR(200),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (storehouse_id) REFERENCES granary_storehouse(storehouse_id)
);
4. ç”¨æˆ·è¡¨ (sys_user)
sql
CREATE TABLE sys_user (
    user_id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    real_name VARCHAR(50) NOT NULL,
    phone VARCHAR(20),
    email VARCHAR(100),
    user_type ENUM('ç³»ç»Ÿç®¡ç†å‘˜', 'ç²®åº“ç®¡ç†å‘˜', 'å·¡æ£€å‘˜') DEFAULT 'å·¡æ£€å‘˜',
    base_id INT,
    status ENUM('å¯ç”¨', 'åœç”¨') DEFAULT 'å¯ç”¨',
    last_login_time DATETIME,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (base_id) REFERENCES granary_base(base_id)
);
é¡¹ç›®ç»“æ„
text
ç²®åº“ç®¡ç†ç³»ç»Ÿ/
â”œâ”€â”€ app/                              # Next.js App Router
â”‚   â”œâ”€â”€ api/                         # API è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ auth/[...nextauth]/route.ts
â”‚   â”‚   â”œâ”€â”€ bases/                   # ç²®åº“ç›¸å…³API
â”‚   â”‚   â”œâ”€â”€ storehouses/             # ç²®ä»“ç›¸å…³API
â”‚   â”‚   â”œâ”€â”€ grains/                  # ç²®é£Ÿç›¸å…³API
â”‚   â”‚   â””â”€â”€ monitoring/              # ç›‘æ§ç›¸å…³API
â”‚   â”œâ”€â”€ (auth)/                      # è®¤è¯ç›¸å…³é¡µé¢ç»„
â”‚   â”‚   â”œâ”€â”€ login/
â”‚   â”‚   â”œâ”€â”€ register/
â”‚   â”‚   â””â”€â”€ layout.tsx
â”‚   â”œâ”€â”€ dashboard/                   # ä»ªè¡¨æ¿
â”‚   â”‚   â”œâ”€â”€ layout.tsx
â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚   â”‚   â””â”€â”€ components/
â”‚   â”œâ”€â”€ bases/                       # ç²®åº“ç®¡ç†
â”‚   â”œâ”€â”€ storehouses/                 # ç²®ä»“ç®¡ç†
â”‚   â”œâ”€â”€ grains/                      # ç²®é£Ÿç®¡ç†
â”‚   â”œâ”€â”€ monitoring/                  # ç›‘æ§ç®¡ç†
â”‚   â”œâ”€â”€ reports/                     # æŠ¥è¡¨ç»Ÿè®¡
â”‚   â””â”€â”€ settings/                    # ç³»ç»Ÿè®¾ç½®
â”œâ”€â”€ components/                       # å¯å¤ç”¨ç»„ä»¶
â”‚   â”œâ”€â”€ ui/                          # åŸºç¡€UIç»„ä»¶
â”‚   â”œâ”€â”€ layout/                      # å¸ƒå±€ç»„ä»¶
â”‚   â”œâ”€â”€ forms/                       # è¡¨å•ç»„ä»¶
â”‚   â””â”€â”€ charts/                      # å›¾è¡¨ç»„ä»¶
â”œâ”€â”€ lib/                             # å·¥å…·å‡½æ•°å’Œé…ç½®
â”‚   â”œâ”€â”€ prisma.ts                    # Prisma å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ auth.ts                      # è®¤è¯é…ç½®
â”‚   â”œâ”€â”€ api.ts                       # API å®¢æˆ·ç«¯
â”‚   â””â”€â”€ utils/                       # å·¥å…·å‡½æ•°
â”œâ”€â”€ prisma/                          # Prisma é…ç½®
â”‚   â”œâ”€â”€ schema.prisma                # æ•°æ®æ¨¡å‹
â”‚   â””â”€â”€ seed.ts                      # ç§å­æ•°æ®
â”œâ”€â”€ types/                           # TypeScript ç±»å‹å®šä¹‰
â”œâ”€â”€ hooks/                           # è‡ªå®šä¹‰ Hooks
â”œâ”€â”€ styles/                          # å…¨å±€æ ·å¼
â””â”€â”€ public/                          # é™æ€èµ„æº
Prisma æ•°æ®æ¨¡å‹
prisma
// prisma/schema.prisma
datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ç²®åº“ä¿¡æ¯è¡¨
model GranaryBase {
  base_id            Int       @id @default(autoincrement())
  base_code          String    @unique @db.VarChar(20)
  base_name          String    @db.VarChar(100)
  province           String?   @db.VarChar(50)
  city               String?   @db.VarChar(50)
  district           String?   @db.VarChar(50)
  address            String?   @db.VarChar(200)
  base_type          BaseType  @default(LOCAL)
  status             Status    @default(ACTIVE)
  total_capacity     Float?    @db.Decimal(12, 2)
  contact_person     String?   @db.VarChar(50)
  contact_phone      String?   @db.VarChar(20)
  established_date   DateTime?
  manager_user_id    Int?
  created_at         DateTime  @default(now())
  updated_at         DateTime  @updatedAt
  
  // å…³è”å…³ç³»
  storehouses GranaryStorehouse[]
  manager     SysUser?            @relation(fields: [manager_user_id], references: [user_id])
  users       SysUser[]
  
  @@index([status])
  @@map("granary_base")
}

// ç²®ä»“ä¿¡æ¯è¡¨
model GranaryStorehouse {
  storehouse_id          Int            @id @default(autoincrement())
  storehouse_code        String         @db.VarChar(20)
  base_id                Int
  storehouse_name        String         @db.VarChar(100)
  storehouse_type        StorehouseType @default(FLAT)
  design_capacity        Float          @db.Decimal(10, 2)
  length                 Float?         @db.Decimal(8, 2)
  width                  Float?         @db.Decimal(8, 2)
  height                 Float?         @db.Decimal(8, 2)
  diameter               Float?         @db.Decimal(8, 2)
  construction_date      DateTime?
  status                 StoreStatus    @default(EMPTY)
  temperature_control    Boolean        @default(false)
  humidity_control       Boolean        @default(false)
  fire_protection_level  String?        @db.VarChar(20)
  current_grain_id       Int?
  current_quantity       Float          @default(0) @db.Decimal(10, 2)
  safety_level           SafetyLevel    @default(NORMAL)
  last_inspection_date   DateTime?
  created_at             DateTime       @default(now())
  updated_at             DateTime       @updatedAt
  
  // å…³è”å…³ç³»
  base            GranaryBase       @relation(fields: [base_id], references: [base_id], onDelete: Cascade)
  current_grain   GrainStorage?     @relation(fields: [current_grain_id], references: [storage_id])
  grain_storages  GrainStorage[]
  monitor_records MonitorRecord[]
  equipment       Equipment[]
  
  @@unique([base_id, storehouse_code])
  @@index([base_id, status])
  @@map("granary_storehouse")
}

// æšä¸¾ç±»å‹
enum BaseType {
  NATIONAL    // å›½å®¶å‚¨å¤‡åº“
  LOCAL       // åœ°æ–¹å‚¨å¤‡åº“
  ENTERPRISE  // ä¼ä¸šä»“åº“
}

enum Status {
  ACTIVE    // å¯ç”¨
  INACTIVE  // åœç”¨
  BUILDING  // åœ¨å»º
}

enum StorehouseType {
  FLAT    // å¹³æˆ¿ä»“
  SILO    // ç­’ä»“
  ROUND   // æµ…åœ†ä»“
  BUILDING // æ¥¼æˆ¿ä»“
}

enum StoreStatus {
  EMPTY     // ç©ºä»“
  STORING   // å­˜å‚¨ä¸­
  REPAIRING // ç»´ä¿®ä¸­
  ABANDONED // å·²åºŸå¼ƒ
}

enum SafetyLevel {
  NORMAL    // æ­£å¸¸
  WARNING   // é¢„è­¦
  DANGEROUS // å±é™©
}
API æ¥å£è®¾è®¡
è®¤è¯æ¥å£
POST /api/auth/login
typescript
// è¯·æ±‚ä½“
{
  "username": "string",
  "password": "string"
}

// å“åº”ä½“
{
  "token": "jwt_token_string",
  "user": {
    "user_id": 1,
    "username": "admin",
    "real_name": "ç®¡ç†å‘˜",
    "user_type": "ç³»ç»Ÿç®¡ç†å‘˜",
    "base_id": 1
  }
}
POST /api/auth/register
typescript
// è¯·æ±‚ä½“
{
  "username": "string",
  "password": "string",
  "real_name": "string",
  "phone": "string",
  "email": "string",
  "user_type": "ç³»ç»Ÿç®¡ç†å‘˜",
  "base_id": 1
}
ç²®åº“ç®¡ç†æ¥å£
GET /api/bases
æŸ¥è¯¢ç²®åº“åˆ—è¡¨

æŸ¥è¯¢å‚æ•°ï¼š

page: é¡µç ï¼ˆé»˜è®¤1ï¼‰

pageSize: æ¯é¡µæ•°é‡ï¼ˆé»˜è®¤20ï¼‰

province: çœä»½ç­›é€‰

city: åŸå¸‚ç­›é€‰

base_type: ç²®åº“ç±»å‹

status: çŠ¶æ€ç­›é€‰

å“åº”ï¼š

json
{
  "data": [
    {
      "base_id": 1,
      "base_code": "BJ001",
      "base_name": "åŒ—äº¬ä¸­å¤®ç²®åº“",
      "province": "åŒ—äº¬",
      "city": "åŒ—äº¬",
      "status": "å¯ç”¨",
      "total_capacity": 50000,
      "storehouse_count": 20,
      "current_storage": 35000
    }
  ],
  "total": 100,
  "page": 1,
  "pageSize": 20
}
POST /api/bases
åˆ›å»ºç²®åº“

typescript
{
  "base_code": "string",
  "base_name": "string",
  "province": "string",
  "city": "string",
  "district": "string",
  "address": "string",
  "base_type": "å›½å®¶å‚¨å¤‡åº“",
  "total_capacity": 50000,
  "contact_person": "string",
  "contact_phone": "string",
  "established_date": "2024-01-01"
}
GET /api/bases/[id]/storehouses
è·å–ç²®åº“ä¸‹å±ç²®ä»“

GET /api/bases/[id]/statistics
è·å–ç²®åº“ç»Ÿè®¡ä¿¡æ¯

json
{
  "storehouse_count": 20,
  "total_capacity": 100000,
  "current_storage": 65000,
  "storage_rate": 65.0,
  "storing_count": 15,
  "empty_count": 3,
  "maintenance_count": 2
}
ç²®ä»“ç®¡ç†æ¥å£
GET /api/storehouses
æŸ¥è¯¢ç²®ä»“åˆ—è¡¨

æŸ¥è¯¢å‚æ•°ï¼š

base_id: æ‰€å±ç²®åº“ID

storehouse_type: ç²®ä»“ç±»å‹

status: çŠ¶æ€

safety_level: å®‰å…¨ç­‰çº§

page: é¡µç 

pageSize: æ¯é¡µæ•°é‡

POST /api/storehouses
åˆ›å»ºç²®ä»“

typescript
{
  "storehouse_code": "SH001",
  "base_id": 1,
  "storehouse_name": "1å·å¹³æˆ¿ä»“",
  "storehouse_type": "å¹³æˆ¿ä»“",
  "design_capacity": 5000,
  "length": 50,
  "width": 20,
  "height": 8,
  "construction_date": "2023-06-01",
  "temperature_control": true,
  "humidity_control": true,
  "fire_protection_level": "ä¸€çº§"
}
ç²®é£Ÿç®¡ç†æ¥å£
POST /api/grains/inbound
ç²®é£Ÿå…¥åº“

typescript
{
  "storehouse_id": 1,
  "grain_type": "å°éº¦",
  "grade": "ä¸€ç­‰",
  "production_year": 2023,
  "origin_province": "æ²³å—",
  "origin_city": "éƒ‘å·",
  "quantity": 1000,
  "unit_price": 2800,
  "storage_date": "2024-01-15",
  "expiration_date": "2025-01-15",
  "supplier": "æ²³å—ç²®æ²¹é›†å›¢",
  "purchase_order_no": "PO20240115001",
  "inspector": "å¼ ä¸‰",
  "moisture_content": 12.5,
  "impurity_content": 1.2,
  "storage_type": "å›½å®¶å‚¨å¤‡"
}
POST /api/grains/outbound
ç²®é£Ÿå‡ºåº“

typescript
{
  "storage_id": 1,
  "outbound_quantity": 500,
  "outbound_reason": "å¸‚åœºä¾›åº”"
}
å‰ç«¯é¡µé¢è®¾è®¡
ä»ªè¡¨æ¿é¡µé¢ (/dashboard)
æ˜¾ç¤ºç³»ç»Ÿæ¦‚è§ˆã€é¢„è­¦ä¿¡æ¯ã€å­˜å‚¨ç»Ÿè®¡å’Œæœ€è¿‘æ“ä½œè®°å½•ã€‚

tsx
// app/dashboard/page.tsx
import { StatCard } from '@/components/ui/stat-card';
import { StorageCapacityChart } from '@/components/charts/storage-capacity-chart';
import { WarningAlerts } from '@/components/dashboard/warning-alerts';
import { RecentActivities } from '@/components/dashboard/recent-activities';

export default function DashboardPage() {
  return (
    <div className="space-y-6">
      {/* ç»Ÿè®¡å¡ç‰‡ */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <StatCard
          title="æ€»ç²®åº“æ•°é‡"
          value={85}
          icon="ğŸ¢"
          trend={5}
          trendLabel="è¾ƒä¸Šæœˆ"
        />
        <StatCard
          title="æ€»ç²®ä»“æ•°é‡"
          value={1250}
          icon="ğŸ“¦"
          trend={3.2}
          trendLabel="è¾ƒä¸Šæœˆ"
        />
        <StatCard
          title="æ€»å­˜å‚¨é‡"
          value="65.2ä¸‡å¨"
          icon="âš–ï¸"
          trend={-1.5}
          trendLabel="è¾ƒä¸Šæœˆ"
        />
        <StatCard
          title="å¹³å‡å­˜å‚¨ç‡"
          value="78.5%"
          icon="ğŸ“Š"
          variant="warning"
        />
      </div>
      
      {/* å›¾è¡¨åŒºåŸŸ */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <StorageCapacityChart />
        <GrainTypeDistribution />
      </div>
      
      {/* é¢„è­¦ä¿¡æ¯ */}
      <WarningAlerts />
      
      {/* æœ€è¿‘æ´»åŠ¨ */}
      <RecentActivities />
    </div>
  );
}
ç²®åº“ç®¡ç†é¡µé¢ (/bases)
åŠŸèƒ½ï¼š

ç²®åº“åˆ—è¡¨å±•ç¤ºï¼ˆæ”¯æŒæœç´¢ã€ç­›é€‰ã€æ’åºï¼‰

åˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤ç²®åº“

æŸ¥çœ‹ç²®åº“è¯¦æƒ…

å¯¼å‡ºç²®åº“æ•°æ®

åœ°å›¾å±•ç¤ºç²®åº“åˆ†å¸ƒ

é¡µé¢å¸ƒå±€ï¼š

tsx
// app/bases/page.tsx
export default function BasesPage() {
  return (
    <div className="flex h-screen">
      {/* å·¦ä¾§åˆ—è¡¨ */}
      <div className="w-1/3 border-r">
        <BaseList />
      </div>
      
      {/* å³ä¾§è¯¦æƒ… */}
      <div className="w-2/3">
        <BaseDetail />
      </div>
    </div>
  );
}
ç²®ä»“è¯¦æƒ…é¡µé¢ (/storehouses/[id])
æ ‡ç­¾é¡µè®¾è®¡ï¼š

åŸºæœ¬ä¿¡æ¯ - ç²®ä»“å±æ€§ã€è§„æ ¼å‚æ•°

å­˜å‚¨çŠ¶æ€ - å½“å‰å­˜å‚¨çš„ç²®é£Ÿä¿¡æ¯

ç›‘æ§æ•°æ® - æ¸©æ¹¿åº¦å›¾è¡¨ã€å†å²è®°å½•

è®¾å¤‡ä¿¡æ¯ - å…³è”è®¾å¤‡åˆ—è¡¨

æ“ä½œè®°å½• - å‡ºå…¥åº“ã€è½®æ¢è®°å½•

tsx
// app/storehouses/[id]/page.tsx
export default function StorehouseDetailPage({
  params,
}: {
  params: { id: string };
}) {
  return (
    <Tabs defaultValue="info">
      <TabsList>
        <TabsTrigger value="info">åŸºæœ¬ä¿¡æ¯</TabsTrigger>
        <TabsTrigger value="storage">å­˜å‚¨çŠ¶æ€</TabsTrigger>
        <TabsTrigger value="monitoring">ç›‘æ§æ•°æ®</TabsTrigger>
        <TabsTrigger value="equipment">è®¾å¤‡ä¿¡æ¯</TabsTrigger>
        <TabsTrigger value="history">æ“ä½œè®°å½•</TabsTrigger>
      </TabsList>
      
      <TabsContent value="info">
        <StorehouseInfo id={params.id} />
      </TabsContent>
      
      <TabsContent value="storage">
        <CurrentStorage id={params.id} />
      </TabsContent>
      
      <TabsContent value="monitoring">
        <MonitoringCharts id={params.id} />
      </TabsContent>
    </Tabs>
  );
}
ç²®é£Ÿå…¥åº“é¡µé¢ (/grains/inbound)
è¡¨å•ç»“æ„ï¼š

å…¥åº“ä¿¡æ¯ - ç²®ä»“é€‰æ‹©ã€ç²®é£Ÿç§ç±»ã€æ•°é‡ç­‰

è´¨é‡ä¿¡æ¯ - æ°´åˆ†å«é‡ã€æ‚è´¨å«é‡ã€ç­‰çº§ç­‰

ä¾›åº”å•†ä¿¡æ¯ - ä¾›åº”å•†ã€é‡‡è´­å•å·ã€æ£€éªŒå‘˜ç­‰

ç¡®è®¤æäº¤ - è¡¨å•éªŒè¯å’Œæäº¤

tsx
// app/grains/inbound/page.tsx
import { InboundForm } from '@/components/forms/inbound-form';

export default function InboundPage() {
  return (
    <div className="container mx-auto py-6">
      <div className="mb-6">
        <h1 className="text-3xl font-bold">ç²®é£Ÿå…¥åº“</h1>
        <p className="text-gray-500">å¡«å†™ç²®é£Ÿå…¥åº“ä¿¡æ¯</p>
      </div>
      
      <InboundForm />
    </div>
  );
}
ç»„ä»¶è®¾è®¡
æ•°æ®è¡¨æ ¼ç»„ä»¶
tsx
// components/ui/data-table.tsx
interface DataTableProps<T> {
  columns: ColumnDef<T>[];
  data: T[];
  pagination?: {
    page: number;
    pageSize: number;
    total: number;
  };
  onPaginationChange?: (pagination: { page: number; pageSize: number }) => void;
  onRowClick?: (row: T) => void;
  loading?: boolean;
}

export function DataTable<T>({
  columns,
  data,
  pagination,
  onPaginationChange,
  onRowClick,
  loading = false,
}: DataTableProps<T>) {
  return (
    <div className="rounded-md border">
      <Table>
        <TableHeader>
          {columns.map((column, index) => (
            <TableHead key={index}>
              {column.header}
            </TableHead>
          ))}
        </TableHeader>
        <TableBody>
          {loading ? (
            <TableRow>
              <TableCell colSpan={columns.length} className="text-center py-8">
                åŠ è½½ä¸­...
              </TableCell>
            </TableRow>
          ) : data.length === 0 ? (
            <TableRow>
              <TableCell colSpan={columns.length} className="text-center py-8">
                æš‚æ— æ•°æ®
              </TableCell>
            </TableRow>
          ) : (
            data.map((row, index) => (
              <TableRow
                key={index}
                className={onRowClick ? 'cursor-pointer hover:bg-gray-50' : ''}
                onClick={() => onRowClick?.(row)}
              >
                {columns.map((column, colIndex) => (
                  <TableCell key={colIndex}>
                    {column.cell ? column.cell(row) : row[column.accessorKey]}
                  </TableCell>
                ))}
              </TableRow>
            ))
          )}
        </TableBody>
      </Table>
      
      {pagination && (
        <div className="flex items-center justify-between px-4 py-3 border-t">
          <Pagination
            current={pagination.page}
            pageSize={pagination.pageSize}
            total={pagination.total}
            onChange={(page, pageSize) => 
              onPaginationChange?.({ page, pageSize })
            }
          />
        </div>
      )}
    </div>
  );
}
è¡¨å•ç»„ä»¶
tsx
// components/forms/storehouse-form.tsx
'use client';

import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { storehouseSchema } from '@/lib/validations';
import type { StorehouseFormData } from '@/types';

interface StorehouseFormProps {
  initialData?: Partial<StorehouseFormData>;
  onSubmit: (data: StorehouseFormData) => Promise<void>;
  onCancel?: () => void;
  loading?: boolean;
}

export function StorehouseForm({
  initialData,
  onSubmit,
  onCancel,
  loading = false,
}: StorehouseFormProps) {
  const form = useForm<StorehouseFormData>({
    resolver: zodResolver(storehouseSchema),
    defaultValues: initialData,
  });

  return (
    <Form {...form}>
      <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <FormField
            control={form.control}
            name="storehouse_code"
            render={({ field }) => (
              <FormItem>
                <FormLabel>ç²®ä»“ç¼–å· *</FormLabel>
                <FormControl>
                  <Input placeholder="ä¾‹å¦‚: SH001" {...field} />
                </FormControl>
                <FormMessage />
              </FormItem>
            )}
          />
          
          <FormField
            control={form.control}
            name="storehouse_name"
            render={({ field }) => (
              <FormItem>
                <FormLabel>ç²®ä»“åç§° *</FormLabel>
                <FormControl>
                  <Input placeholder="ä¾‹å¦‚: 1å·å¹³æˆ¿ä»“" {...field} />
                </FormControl>
                <FormMessage />
              </FormItem>
            )}
          />
          
          {/* æ›´å¤šè¡¨å•é¡¹... */}
        </div>
        
        <div className="flex justify-end gap-4">
          {onCancel && (
            <Button type="button" variant="outline" onClick={onCancel}>
              å–æ¶ˆ
            </Button>
          )}
          <Button type="submit" disabled={loading}>
            {loading ? 'æäº¤ä¸­...' : 'æäº¤'}
          </Button>
        </div>
      </form>
    </Form>
  );
}
ç›‘æ§å›¾è¡¨ç»„ä»¶
tsx
// components/charts/temperature-chart.tsx
'use client';

import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';

interface TemperatureChartProps {
  data: Array<{
    time: string;
    temperature: number;
    humidity: number;
  }>;
  height?: number;
}

export function TemperatureChart({ data, height = 300 }: TemperatureChartProps) {
  return (
    <ResponsiveContainer width="100%" height={height}>
      <LineChart data={data}>
        <CartesianGrid strokeDasharray="3 3" />
        <XAxis dataKey="time" />
        <YAxis yAxisId="left" />
        <YAxis yAxisId="right" orientation="right" />
        <Tooltip />
        <Line
          yAxisId="left"
          type="monotone"
          dataKey="temperature"
          stroke="#ff7300"
          strokeWidth={2}
          dot={{ r: 2 }}
          name="æ¸©åº¦(â„ƒ)"
        />
        <Line
          yAxisId="right"
          type="monotone"
          dataKey="humidity"
          stroke="#387908"
          strokeWidth={2}
          dot={{ r: 2 }}
          name="æ¹¿åº¦(%)"
        />
      </LineChart>
    </ResponsiveContainer>
  );
}
æƒé™æ§åˆ¶
è§’è‰²å®šä¹‰
typescript
// lib/permissions.ts
export enum UserRole {
  SUPER_ADMIN = 'ç³»ç»Ÿç®¡ç†å‘˜',
  BASE_ADMIN = 'ç²®åº“ç®¡ç†å‘˜',
  INSPECTOR = 'å·¡æ£€å‘˜',
}

export const permissions = {
  [UserRole.SUPER_ADMIN]: {
    bases: ['create', 'read', 'update', 'delete', 'manage_all'],
    storehouses: ['create', 'read', 'update', 'delete', 'manage_all'],
    grains: ['inbound', 'outbound', 'rotate', 'read_all'],
    users: ['create', 'read', 'update', 'delete', 'manage_all'],
    reports: ['view_all', 'export'],
  },
  [UserRole.BASE_ADMIN]: {
    bases: ['read_own', 'update_own'],
    storehouses: ['create_own', 'read_own', 'update_own'],
    grains: ['inbound_own', 'outbound_own', 'rotate_own', 'read_own'],
    users: ['read_own'],
    reports: ['view_own'],
  },
  [UserRole.INSPECTOR]: {
    bases: ['read_own'],
    storehouses: ['read_own', 'monitor'],
    grains: ['read_own'],
    users: [],
    reports: [],
  },
};
æƒé™å®ˆå«ç»„ä»¶
tsx
// components/auth/permission-guard.tsx
'use client';

import { useAuth } from '@/hooks/use-auth';
import { hasPermission } from '@/lib/permissions';

interface PermissionGuardProps {
  children: React.ReactNode;
  requiredPermission: string;
  resource?: string;
  fallback?: React.ReactNode;
}

export function PermissionGuard({
  children,
  requiredPermission,
  resource,
  fallback,
}: PermissionGuardProps) {
  const { user, isLoading } = useAuth();
  
  if (isLoading) {
    return <div>æƒé™éªŒè¯ä¸­...</div>;
  }
  
  if (!user || !hasPermission(user, requiredPermission, resource)) {
    return fallback || (
      <div className="p-8 text-center">
        <AlertTriangle className="h-12 w-12 text-yellow-500 mx-auto mb-4" />
        <h3 className="text-lg font-semibold">æƒé™ä¸è¶³</h3>
        <p className="text-gray-500">æ‚¨æ²¡æœ‰è®¿é—®æ­¤é¡µé¢çš„æƒé™</p>
      </div>
    );
  }
  
  return <>{children}</>;
}
çŠ¶æ€ç®¡ç†
è®¤è¯çŠ¶æ€ç®¡ç†
typescript
// stores/auth-store.ts
import { create } from 'zustand';
import { persist } from 'zustand/middleware';

interface User {
  user_id: number;
  username: string;
  real_name: string;
  user_type: string;
  base_id?: number;
  token?: string;
}

interface AuthState {
  user: User | null;
  token: string | null;
  isAuthenticated: boolean;
  isLoading: boolean;
  
  // Actions
  login: (userData: User, token: string) => void;
  logout: () => void;
  setUser: (user: Partial<User>) => void;
  setLoading: (loading: boolean) => void;
}

export const useAuthStore = create<AuthState>()(
  persist(
    (set) => ({
      user: null,
      token: null,
      isAuthenticated: false,
      isLoading: false,
      
      login: (userData, token) => {
        set({
          user: { ...userData, token },
          token,
          isAuthenticated: true,
          isLoading: false,
        });
      },
      
      logout: () => {
        set({
          user: null,
          token: null,
          isAuthenticated: false,
          isLoading: false,
        });
      },
      
      setUser: (userData) => {
        set((state) => ({
          user: state.user ? { ...state.user, ...userData } : null,
        }));
      },
      
      setLoading: (loading) => {
        set({ isLoading: loading });
      },
    }),
    {
      name: 'auth-storage',
    }
  )
);
API å®¢æˆ·ç«¯
typescript
// lib/api.ts
class ApiClient {
  private baseURL: string;

  constructor() {
    this.baseURL = process.env.NEXT_PUBLIC_API_URL || '/api';
  }

  private async request<T>(
    endpoint: string,
    options: RequestInit = {}
  ): Promise<T> {
    const token = useAuthStore.getState().token;
    
    const headers: HeadersInit = {
      'Content-Type': 'application/json',
      ...(token && { Authorization: `Bearer ${token}` }),
      ...options.headers,
    };

    const url = `${this.baseURL}${endpoint}`;
    
    try {
      const response = await fetch(url, {
        ...options,
        headers,
        credentials: 'include',
      });

      if (response.status === 401) {
        // Tokenè¿‡æœŸï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
        useAuthStore.getState().logout();
        window.location.href = '/login';
        throw new Error('èº«ä»½éªŒè¯å¤±è´¥');
      }

      if (!response.ok) {
        const error = await response.json().catch(() => ({}));
        throw new Error(error.message || `è¯·æ±‚å¤±è´¥: ${response.status}`);
      }

      return await response.json();
    } catch (error) {
      console.error('APIè¯·æ±‚é”™è¯¯:', error);
      throw error;
    }
  }

  // ç²®åº“ç›¸å…³API
  bases = {
    list: (params?: Record<string, any>) => 
      this.request('/bases', {
        method: 'GET',
        ...(params && { 
          body: JSON.stringify(params) 
        }),
      }),
    
    get: (id: number) => 
      this.request(`/bases/${id}`),
    
    create: (data: any) =>
      this.request('/bases', {
        method: 'POST',
        body: JSON.stringify(data),
      }),
    
    update: (id: number, data: any) =>
      this.request(`/bases/${id}`, {
        method: 'PUT',
        body: JSON.stringify(data),
      }),
    
    delete: (id: number) =>
      this.request(`/bases/${id}`, {
        method: 'DELETE',
      }),
    
    getStatistics: (id: number) =>
      this.request(`/bases/${id}/statistics`),
  };

  // ç²®ä»“ç›¸å…³API
  storehouses = {
    list: (params?: Record<string, any>) =>
      this.request('/storehouses', {
        method: 'GET',
        ...(params && { body: JSON.stringify(params) }),
      }),
    
    get: (id: number) =>
      this.request(`/storehouses/${id}`),
    
    create: (data: any) =>
      this.request('/storehouses', {
        method: 'POST',
        body: JSON.stringify(data),
      }),
    
    getMonitoring: (id: number, params?: Record<string, any>) =>
      this.request(`/storehouses/${id}/monitoring`, {
        method: 'GET',
        ...(params && { body: JSON.stringify(params) }),
      }),
  };

  // è®¤è¯ç›¸å…³API
  auth = {
    login: (credentials: { username: string; password: string }) =>
      this.request('/auth/login', {
        method: 'POST',
        body: JSON.stringify(credentials),
      }),
    
    register: (data: any) =>
      this.request('/auth/register', {
        method: 'POST',
        body: JSON.stringify(data),
      }),
    
    logout: () =>
      this.request('/auth/logout', {
        method: 'POST',
      }),
  };
}

export const api = new ApiClient();
ç¯å¢ƒé…ç½®
ç¯å¢ƒå˜é‡
env
# .env.local
# æ•°æ®åº“é…ç½®
DATABASE_URL="mysql://username:password@localhost:3306/granary_management"

# NextAuth é…ç½®
NEXTAUTH_URL="http://localhost:3000"
NEXTAUTH_SECRET="your-secret-key-here"

# API é…ç½®
NEXT_PUBLIC_API_URL="http://localhost:3000/api"

# åœ°å›¾æœåŠ¡ï¼ˆå¯é€‰ï¼‰
NEXT_PUBLIC_MAPBOX_TOKEN="your-mapbox-token"

# æ–‡ä»¶ä¸Šä¼ é…ç½®
NEXT_PUBLIC_UPLOAD_MAX_SIZE="5242880" # 5MB
package.json è„šæœ¬
json
{
  "scripts": {
    "dev": "next dev",
    "build": "prisma generate && prisma db push && next build",
    "start": "next start",
    "lint": "next lint",
    "prisma:studio": "prisma studio",
    "prisma:migrate": "prisma migrate dev",
    "prisma:seed": "tsx prisma/seed.ts",
    "test": "jest",
    "test:watch": "jest --watch",
    "test:e2e": "playwright test"
  }
}
éƒ¨ç½²é…ç½®
Docker é…ç½®
dockerfile
# Dockerfile
FROM node:18-alpine AS base

# å®‰è£…ä¾èµ–
FROM base AS deps
RUN apk add --no-cache libc6-compat openssl
WORKDIR /app
COPY package.json package-lock.json* ./
RUN npm ci

# æ„å»ºé˜¶æ®µ
FROM base AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .
RUN npx prisma generate
RUN npm run build

# ç”Ÿäº§é•œåƒ
FROM base AS runner
WORKDIR /app

ENV NODE_ENV=production

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

COPY --from=builder /app/public ./public
COPY --from=builder /app/.next/standalone ./
COPY --from=builder /app/.next/static ./.next/static
COPY --from=builder /app/prisma ./prisma

USER nextjs

EXPOSE 3000

ENV PORT=3000
ENV HOSTNAME="0.0.0.0"

CMD ["node", "server.js"]
docker-compose.yml
yaml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: granary_management
      MYSQL_USER: granary_user
      MYSQL_PASSWORD: granary_password
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    command: --default-authentication-plugin=mysql_native_password

  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      DATABASE_URL: mysql://granary_user:granary_password@mysql:3306/granary_management
      NEXTAUTH_URL: http://localhost:3000
      NEXTAUTH_SECRET: your-secret-key
    depends_on:
      - mysql
    volumes:
      - ./uploads:/app/uploads

volumes:
  mysql_data:
Vercel éƒ¨ç½²é…ç½®
json
// vercel.json
{
  "version": 2,
  "buildCommand": "prisma generate && npm run build",
  "installCommand": "npm install",
  "framework": "nextjs",
  "env": {
    "DATABASE_URL": {
      "type": "encrypted",
      "value": "your-database-url"
    },
    "NEXTAUTH_SECRET": {
      "type": "encrypted",
      "value": "your-secret-key"
    }
  },
  "builds": [
    {
      "src": "package.json",
      "use": "@vercel/next"
    }
  ]
}
å¼€å‘è§„èŒƒ
ä»£ç æäº¤è§„èŒƒ
text
feat: æ–°å¢åŠŸèƒ½
fix: ä¿®å¤bug
docs: æ–‡æ¡£æ›´æ–°
style: ä»£ç æ ¼å¼è°ƒæ•´
refactor: ä»£ç é‡æ„
test: æµ‹è¯•ç›¸å…³
chore: æ„å»ºè¿‡ç¨‹æˆ–è¾…åŠ©å·¥å…·å˜åŠ¨
perf: æ€§èƒ½ä¼˜åŒ–
ci: CIé…ç½®ç›¸å…³
ç¤ºä¾‹ï¼š

bash
git commit -m "feat: æ·»åŠ ç²®åº“ç®¡ç†é¡µé¢"
git commit -m "fix: ä¿®å¤ç²®é£Ÿå…¥åº“è¡¨å•éªŒè¯é—®é¢˜"
git commit -m "docs: æ›´æ–°APIæ¥å£æ–‡æ¡£"
æ–‡ä»¶å‘½åè§„èŒƒ
é¡µé¢æ–‡ä»¶ï¼šä½¿ç”¨ kebab-case

text
/app/bases/page.tsx
/app/storehouses/[id]/page.tsx
ç»„ä»¶æ–‡ä»¶ï¼šä½¿ç”¨ PascalCase

text
/components/ui/DataTable.tsx
/components/forms/InboundForm.tsx
å·¥å…·å‡½æ•°ï¼šä½¿ç”¨ camelCase

text
/lib/utils/formatDate.ts
/lib/validations/storehouseSchema.ts
ä»£ç é£æ ¼è§„èŒƒ
TypeScript é…ç½®

json
{
  "compilerOptions": {
    "target": "es5",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "forceConsistentCasingInFileNames": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  }
}
ESLint é…ç½®

json
{
  "extends": [
    "next/core-web-vitals",
    "eslint:recommended",
    "plugin:@typescript-eslint/recommended"
  ],
  "rules": {
    "@typescript-eslint/no-unused-vars": "warn",
    "@typescript-eslint/no-explicit-any": "warn",
    "react-hooks/rules-of-hooks": "error",
    "react-hooks/exhaustive-deps": "warn"
  }
}
æµ‹è¯•ç­–ç•¥
å•å…ƒæµ‹è¯•
typescript
// __tests__/utils/format-date.test.ts
import { formatDate } from '@/lib/utils/format-date';

describe('formatDate', () => {
  it('åº”è¯¥æ­£ç¡®æ ¼å¼åŒ–æ—¥æœŸ', () => {
    const date = new Date('2024-01-01T00:00:00Z');
    expect(formatDate(date)).toBe('2024-01-01');
  });

  it('åº”è¯¥å¤„ç†ç©ºå€¼', () => {
    expect(formatDate(null)).toBe('');
    expect(formatDate(undefined)).toBe('');
  });
});
API æ¥å£æµ‹è¯•
typescript
// __tests__/api/bases.test.ts
import { createMocks } from 'node-mocks-http';
import handler from '@/app/api/bases/route';

describe('ç²®åº“API', () => {
  it('GET /api/bases åº”è¯¥è¿”å›ç²®åº“åˆ—è¡¨', async () => {
    const { req, res } = createMocks({
      method: 'GET',
    });

    await handler(req, res);
    
    expect(res._getStatusCode()).toBe(200);
    expect(JSON.parse(res._getData())).toHaveProperty('data');
  });

  it('POST /api/bases åº”è¯¥åˆ›å»ºç²®åº“', async () => {
    const { req, res } = createMocks({
      method: 'POST',
      body: {
        base_code: 'TEST001',
        base_name: 'æµ‹è¯•ç²®åº“',
        province: 'åŒ—äº¬',
        city: 'åŒ—äº¬',
      },
    });

    await handler(req, res);
    
    expect(res._getStatusCode()).toBe(201);
    expect(JSON.parse(res._getData())).toHaveProperty('base_id');
  });
});
ç»„ä»¶æµ‹è¯•
typescript
// __tests__/components/StatCard.test.tsx
import { render, screen } from '@testing-library/react';
import { StatCard } from '@/components/ui/stat-card';

describe('StatCard', () => {
  it('åº”è¯¥æ­£ç¡®æ˜¾ç¤ºæ ‡é¢˜å’Œå€¼', () => {
    render(
      <StatCard
        title="æµ‹è¯•æ ‡é¢˜"
        value="100"
        icon="ğŸ“Š"
      />
    );

    expect(screen.getByText('æµ‹è¯•æ ‡é¢˜')).toBeInTheDocument();
    expect(screen.getByText('100')).toBeInTheDocument();
  });

  it('åº”è¯¥æ˜¾ç¤ºè¶‹åŠ¿å€¼', () => {
    render(
      <StatCard
        title="æµ‹è¯•"
        value="100"
        trend={5.5}
        trendLabel="è¾ƒä¸Šæœˆ"
      />
    );

    expect(screen.getByText('+5.5%')).toBeInTheDocument();
    expect(screen.getByText('è¾ƒä¸Šæœˆ')).toBeInTheDocument();
  });
});
E2E æµ‹è¯•
typescript
// e2e/dashboard.spec.ts
import { test, expect } from '@playwright/test';

test('ä»ªè¡¨æ¿é¡µé¢', async ({ page }) => {
  // ç™»å½•
  await page.goto('/login');
  await page.fill('input[name="username"]', 'admin');
  await page.fill('input[name="password"]', 'password123');
  await page.click('button[type="submit"]');
  
  // ç­‰å¾…å¯¼èˆªåˆ°ä»ªè¡¨æ¿
  await page.waitForURL('/dashboard');
  
  // éªŒè¯é¡µé¢å…ƒç´ 
  await expect(page.locator('h1')).toContainText('ä»ªè¡¨æ¿');
  await expect(page.locator('.stat-card')).toHaveCount(4);
  await expect(page.locator('.warning-alert')).toBeVisible();
  
  // æµ‹è¯•å¯¼èˆª
  await page.click('a[href="/bases"]');
  await expect(page).toHaveURL('/bases');
});
æ€§èƒ½ä¼˜åŒ–
1. å›¾ç‰‡ä¼˜åŒ–
tsx
// ä½¿ç”¨ Next.js Image ç»„ä»¶
import Image from 'next/image';

export function OptimizedImage() {
  return (
    <Image
      src="/map-background.jpg"
      alt="ç²®åº“åˆ†å¸ƒåœ°å›¾"
      width={1200}
      height={600}
      priority={false} // éé¦–å±å›¾ç‰‡ä¸è®¾ç½®ä¼˜å…ˆçº§
      sizes="(max-width: 768px) 100vw, 1200px"
      quality={85}
      placeholder="blur"
      blurDataURL="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAABAAEDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAv/xAAUEAEAAAAAAAAAAAAAAAAAAAAA/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAX/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwCdABmX/9k="
    />
  );
}
2. ä»£ç åˆ†å‰²
tsx
// åŠ¨æ€å¯¼å…¥å¤§ç»„ä»¶
import dynamic from 'next/dynamic';

const HeavyChart = dynamic(
  () => import('@/components/charts/heavy-chart'),
  { 
    loading: () => <div className="h-64 animate-pulse bg-gray-200 rounded" />,
    ssr: false // å®¢æˆ·ç«¯æ¸²æŸ“
  }
);

const MapComponent = dynamic(
  () => import('@/components/map/base-map'),
  {
    loading: () => <MapSkeleton />,
  }
);
3. æ•°æ®ç¼“å­˜
tsx
// ä½¿ç”¨ React Query è¿›è¡Œæ•°æ®ç¼“å­˜
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';

export function BaseList() {
  const queryClient = useQueryClient();
  
  // æŸ¥è¯¢æ•°æ®ï¼Œè‡ªåŠ¨ç¼“å­˜
  const { data, isLoading, error } = useQuery({
    queryKey: ['bases'],
    queryFn: () => api.bases.list(),
    staleTime: 5 * 60 * 1000, // 5åˆ†é’Ÿ
    cacheTime: 10 * 60 * 1000, // 10åˆ†é’Ÿ
  });
  
  // åˆ›å»ºç²®åº“çš„Mutation
  const createMutation = useMutation({
    mutationFn: (data: CreateBaseRequest) => api.bases.create(data),
    onSuccess: () => {
      // åˆ›å»ºæˆåŠŸååˆ·æ–°åˆ—è¡¨
      queryClient.invalidateQueries({ queryKey: ['bases'] });
    },
  });
  
  if (isLoading) return <LoadingSpinner />;
  if (error) return <ErrorMessage error={error} />;
  
  return (
    <div>
      <DataTable data={data.data} />
      <button 
        onClick={() => createMutation.mutate({ /* è¡¨å•æ•°æ® */ })}
        disabled={createMutation.isLoading}
      >
        {createMutation.isLoading ? 'åˆ›å»ºä¸­...' : 'åˆ›å»ºç²®åº“'}
      </button>
    </div>
  );
}
4. æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
typescript
// ä½¿ç”¨ Prisma çš„ä¼˜åŒ–æŸ¥è¯¢
// lib/prisma.ts
import { PrismaClient } from '@prisma/client';

const globalForPrisma = globalThis as unknown as {
  prisma: PrismaClient | undefined;
};

export const prisma = globalForPrisma.prisma ?? new PrismaClient({
  log: process.env.NODE_ENV === 'development' ? ['query', 'error', 'warn'] : ['error'],
});

// ä¼˜åŒ–æŸ¥è¯¢ç¤ºä¾‹
export async function getBaseWithStatistics(baseId: number) {
  return prisma.granaryBase.findUnique({
    where: { base_id: baseId },
    include: {
      storehouses: {
        select: {
          storehouse_id: true,
          storehouse_name: true,
          design_capacity: true,
          current_quantity: true,
          status: true,
        },
      },
      _count: {
        select: {
          storehouses: true,
          users: true,
        },
      },
    },
  });
}
å®‰å…¨è€ƒè™‘
1. è¾“å…¥éªŒè¯
typescript
// lib/validations/storehouse-schema.ts
import { z } from 'zod';

export const storehouseSchema = z.object({
  storehouse_code: z.string()
    .min(3, 'ç²®ä»“ç¼–å·è‡³å°‘3ä¸ªå­—ç¬¦')
    .max(20, 'ç²®ä»“ç¼–å·æœ€å¤š20ä¸ªå­—ç¬¦')
    .regex(/^[A-Z0-9]+$/, 'åªèƒ½åŒ…å«å¤§å†™å­—æ¯å’Œæ•°å­—'),
  
  storehouse_name: z.string()
    .min(2, 'ç²®ä»“åç§°è‡³å°‘2ä¸ªå­—ç¬¦')
    .max(100, 'ç²®ä»“åç§°æœ€å¤š100ä¸ªå­—ç¬¦'),
  
  design_capacity: z.number()
    .min(0, 'è®¾è®¡å®¹é‡å¿…é¡»å¤§äº0')
    .max(1000000, 'è®¾è®¡å®¹é‡ä¸èƒ½è¶…è¿‡1000000å¨'),
  
  length: z.number()
    .min(0, 'é•¿åº¦å¿…é¡»å¤§äº0')
    .max(1000, 'é•¿åº¦ä¸èƒ½è¶…è¿‡1000ç±³')
    .optional(),
  
  temperature_control: z.boolean(),
  humidity_control: z.boolean(),
  
  fire_protection_level: z.enum(['ä¸€çº§', 'äºŒçº§', 'ä¸‰çº§', 'å››çº§'])
    .optional(),
});
2. SQL æ³¨å…¥é˜²æŠ¤
typescript
// ä½¿ç”¨ Prisma çš„å‚æ•°åŒ–æŸ¥è¯¢
// âŒ ä¸å®‰å…¨
const query = `SELECT * FROM users WHERE username = '${username}'`;

// âœ… å®‰å…¨ - ä½¿ç”¨ Prisma
const user = await prisma.user.findUnique({
  where: { username },
});

// âœ… å®‰å…¨ - åŸç”ŸæŸ¥è¯¢ä½¿ç”¨å‚æ•°
await prisma.$queryRaw`
  SELECT * FROM users 
  WHERE username = ${username}
`;
3. è·¨ç«™è„šæœ¬é˜²æŠ¤ (XSS)
tsx
// ä½¿ç”¨ React çš„è‡ªåŠ¨è½¬ä¹‰
// âŒ ä¸å®‰å…¨
<div dangerouslySetInnerHTML={{ __html: userContent }} />

// âœ… å®‰å…¨ - ä½¿ç”¨æ–‡æœ¬èŠ‚ç‚¹
<div>{userContent}</div>

// âœ… å®‰å…¨ - ä½¿ç”¨ DOMPurify æ¸…ç†
import DOMPurify from 'dompurify';

const cleanHTML = DOMPurify.sanitize(userContent);
4. æ–‡ä»¶ä¸Šä¼ å®‰å…¨
typescript
// lib/file-upload.ts
import { NextApiRequest } from 'next';
import formidable from 'formidable';
import fs from 'fs';
import path from 'path';

const ALLOWED_EXTENSIONS = ['.jpg', '.jpeg', '.png', '.pdf'];
const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB

export async function handleFileUpload(req: NextApiRequest) {
  const form = formidable({
    multiples: false,
    maxFileSize: MAX_FILE_SIZE,
    filter: ({ mimetype }) => {
      // æ£€æŸ¥ MIME ç±»å‹
      const allowedMimeTypes = ['image/jpeg', 'image/png', 'application/pdf'];
      return allowedMimeTypes.includes(mimetype || '');
    },
  });

  return new Promise((resolve, reject) => {
    form.parse(req, (err, fields, files) => {
      if (err) {
        reject(new Error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥'));
        return;
      }

      const file = files.file?.[0];
      if (!file) {
        reject(new Error('æ²¡æœ‰ä¸Šä¼ æ–‡ä»¶'));
        return;
      }

      // æ£€æŸ¥æ–‡ä»¶æ‰©å±•å
      const ext = path.extname(file.originalFilename || '').toLowerCase();
      if (!ALLOWED_EXTENSIONS.includes(ext)) {
        reject(new Error('ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹'));
        return;
      }

      // ç”Ÿæˆå®‰å…¨çš„æ–‡ä»¶å
      const safeFileName = `${Date.now()}-${Math.random()
        .toString(36)
        .substring(2)}${ext}`;
      
      const uploadPath = path.join(process.cwd(), 'uploads', safeFileName);

      // ç§»åŠ¨æ–‡ä»¶åˆ°å®‰å…¨ä½ç½®
      fs.renameSync(file.filepath, uploadPath);

      resolve({
        filename: safeFileName,
        originalName: file.originalFilename,
        size: file.size,
        mimetype: file.mimetype,
      });
    });
  });
}
ç›‘æ§ä¸æ—¥å¿—
åº”ç”¨ç›‘æ§
typescript
// lib/monitoring.ts
import winston from 'winston';

const logger = winston.createLogger({
  level: 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.json()
  ),
  transports: [
    new winston.transports.File({ filename: 'logs/error.log', level: 'error' }),
    new winston.transports.File({ filename: 'logs/combined.log' }),
    new winston.transports.Console({
      format: winston.format.simple(),
    }),
  ],
});

// API é”™è¯¯ç›‘æ§
export function logApiError(
  endpoint: string,
  error: Error,
  userId?: number,
  metadata?: Record<string, any>
) {
  logger.error({
    message: 'API Error',
    endpoint,
    error: error.message,
    stack: error.stack,
    userId,
    metadata,
    timestamp: new Date().toISOString(),
  });
}

// æ€§èƒ½ç›‘æ§
export function logPerformance(
  operation: string,
  duration: number,
  metadata?: Record<string, any>
) {
  if (duration > 1000) { // è¶…è¿‡1ç§’çš„æ“ä½œ
    logger.warn({
      message: 'Performance Warning',
      operation,
      duration,
      metadata,
    });
  }
}
æ•°æ®åº“ç›‘æ§
sql
-- æ…¢æŸ¥è¯¢æ—¥å¿—é…ç½®
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 2; -- 2ç§’
SET GLOBAL slow_query_log_file = '/var/log/mysql/slow-query.log';

-- ç›‘æ§æŸ¥è¯¢ç¤ºä¾‹
SELECT 
  table_name,
  table_rows,
  data_length,
  index_length,
  ROUND((data_length + index_length) / 1024 / 1024, 2) AS total_mb
FROM information_schema.tables
WHERE table_schema = 'granary_management'
ORDER BY total_mb DESC;
å¤‡ä»½ç­–ç•¥
æ•°æ®åº“å¤‡ä»½
bash
#!/bin/bash
# backup.sh

# æ•°æ®åº“å¤‡ä»½
BACKUP_DIR="/backup/granary"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="granary_management"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# æ‰§è¡Œå¤‡ä»½
mysqldump -u root -p$DB_PASSWORD $DB_NAME | gzip > $BACKUP_DIR/backup_$DATE.sql.gz

# ä¿ç•™æœ€è¿‘7å¤©çš„å¤‡ä»½
find $BACKUP_DIR -name "backup_*.sql.gz" -mtime +7 -delete

# ä¸Šä¼ åˆ°äº‘å­˜å‚¨ï¼ˆå¯é€‰ï¼‰
# aws s3 cp $BACKUP_DIR/backup_$DATE.sql.gz s3://your-bucket/backups/
é…ç½®æ–‡ä»¶å¤‡ä»½
yaml
# docker-compose.backup.yml
version: '3.8'

services:
  backup:
    image: mariadb:10.6
    command: >
      sh -c '
        while true; do
          sleep $${BACKUP_INTERVAL:-86400};
          mysqldump -h mysql -u root -p$${MYSQL_ROOT_PASSWORD} granary_management | gzip > /backup/backup_$$(date +%Y%m%d_%H%M%S).sql.gz;
          find /backup -name "*.sql.gz" -mtime +7 -delete;
        done
      '
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
    volumes:
      - backup_data:/backup
    depends_on:
      - mysql

volumes:
  backup_data:
æ•…éšœæ¢å¤
æ•°æ®åº“æ¢å¤
sql
-- ä»å¤‡ä»½æ¢å¤æ•°æ®åº“
-- 1. åˆ›å»ºç©ºæ•°æ®åº“
CREATE DATABASE granary_management_restore;

-- 2. æ¢å¤æ•°æ®
mysql -u root -p granary_management_restore < backup_file.sql

-- 3. éªŒè¯æ•°æ®
USE granary_management_restore;
SELECT COUNT(*) FROM granary_base;
SELECT COUNT(*) FROM granary_storehouse;
SELECT COUNT(*) FROM grain_storage;

-- 4. åˆ‡æ¢æ•°æ®åº“
-- åœæ­¢åº”ç”¨
-- é‡å‘½ååŸæ•°æ®åº“
RENAME DATABASE granary_management TO granary_management_old;
RENAME DATABASE granary_management_restore TO granary_management;
-- å¯åŠ¨åº”ç”¨
åº”ç”¨å›æ»š
bash
#!/bin/bash
# rollback.sh

# è·å–å½“å‰ç‰ˆæœ¬
CURRENT_VERSION=$(git describe --tags)

# å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
PREVIOUS_VERSION=$(git describe --tags --abbrev=0 $CURRENT_VERSION^)
git checkout $PREVIOUS_VERSION

# é‡æ–°æ„å»º
npm ci
npx prisma generate
npm run build

# é‡å¯åº”ç”¨
pm2 restart granary-app

echo "å·²å›æ»šåˆ°ç‰ˆæœ¬: $PREVIOUS_VERSION"
æ‰©å±•è®¡åˆ’
ç¬¬ä¸€é˜¶æ®µ (1-2å‘¨)
âœ… æ•°æ®åº“è®¾è®¡

âœ… APIæ¥å£è®¾è®¡

âœ… åŸºç¡€é¡µé¢æ¡†æ¶

âœ… ç”¨æˆ·è®¤è¯ç³»ç»Ÿ

ç¬¬äºŒé˜¶æ®µ (2-3å‘¨)
âœ… ç²®åº“ç®¡ç†æ¨¡å—

âœ… ç²®ä»“ç®¡ç†æ¨¡å—

âœ… åŸºç¡€å›¾è¡¨å±•ç¤º

âœ… æƒé™æ§åˆ¶ç³»ç»Ÿ

ç¬¬ä¸‰é˜¶æ®µ (2-3å‘¨)
âœ… ç²®é£Ÿå…¥åº“å‡ºåº“

âœ… ç›‘æ§æ•°æ®é‡‡é›†

âœ… æŠ¥è¡¨ç”Ÿæˆ

âœ… ç§»åŠ¨ç«¯é€‚é…

ç¬¬å››é˜¶æ®µ (1-2å‘¨)
ğŸ”„ é«˜çº§æ•°æ®åˆ†æ

ğŸ”„ é¢„è­¦æ¨é€ç³»ç»Ÿ

ğŸ”„ ç¬¬ä¸‰æ–¹é›†æˆ

ğŸ”„ æ€§èƒ½ä¼˜åŒ–

è”ç³»æ–¹å¼
é¡¹ç›®è´Ÿè´£äºº: [æ‚¨çš„å§“å]
æŠ€æœ¯æ ˆ: Next.js 14 + TypeScript + Prisma + MySQL
å¼€å‘å‘¨æœŸ: 8-10å‘¨
éƒ¨ç½²æ–¹å¼: Docker / Vercel / è‡ªæœ‰æœåŠ¡å™¨

æ–‡æ¡£ç‰ˆæœ¬: 1.0.0
æœ€åæ›´æ–°: 2024å¹´1æœˆ
ç‰ˆæƒæ‰€æœ‰ Â© 2024 ç²®åº“ç®¡ç†ç³»ç»Ÿå¼€å‘å›¢é˜Ÿ

è¿™ä¸ªå¼€å‘æ–‡æ¡£æä¾›äº†ä»æ•°æ®åº“è®¾è®¡åˆ°éƒ¨ç½²è¿ç»´çš„å®Œæ•´æŒ‡å¯¼ï¼Œæ¶µç›–äº†ï¼š

æŠ€æœ¯æ¶æ„ - å®Œæ•´çš„æŠ€æœ¯æ ˆé€‰æ‹©

æ•°æ®åº“è®¾è®¡ - è¯¦ç»†çš„æ•°æ®è¡¨ç»“æ„

APIè®¾è®¡ - RESTful APIæ¥å£è§„èŒƒ

å‰ç«¯å¼€å‘ - é¡µé¢å’Œç»„ä»¶è®¾è®¡

æƒé™æ§åˆ¶ - å¤šè§’è‰²æƒé™ç®¡ç†ç³»ç»Ÿ

éƒ¨ç½²è¿ç»´ - Dockerã€ç›‘æ§ã€å¤‡ä»½ç­–ç•¥

å®‰å…¨è€ƒè™‘ - å…¨é¢çš„å®‰å…¨é˜²æŠ¤æªæ–½

æµ‹è¯•ç­–ç•¥ - å•å…ƒæµ‹è¯•åˆ°E2Eæµ‹è¯•

æ ¹æ®å®é™…é¡¹ç›®éœ€æ±‚ï¼Œå¯ä»¥è°ƒæ•´å’Œæ‰©å±•å„ä¸ªéƒ¨åˆ†ã€‚å»ºè®®æŒ‰ç…§é˜¶æ®µé€æ­¥å¼€å‘ï¼Œä¼˜å…ˆå®ç°æ ¸å¿ƒåŠŸèƒ½ï¼Œå†é€æ­¥å®Œå–„é«˜çº§ç‰¹æ€§ã€‚